<!DOCTYPE html>
<html lang="en">
<head>
    <title>Embedded Formstack with Referrer Tracking</title>
    <script>
document.addEventListener("DOMContentLoaded", function () {
    function getQueryParam(param) {
        let urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
    }

    function getReferrerSource() {
        // 1Ô∏è‚É£ Detect Facebook, Messenger, Instagram via fbclid
        if (getQueryParam("fbclid")) {
            return "facebook.com";  
        }

        let referrer = document.referrer;

        // 2Ô∏è‚É£ Detect Email Clicks
        const emailDomains = [
            "mail.google.com", "outlook.live.com", "yahoo.com", "icloud.com",
            "aol.com", "zoho.com", "mail.proton.me", "fastmail.com",
            "yandex.com", "gmx.com", "mail.com"
        ];

        if (referrer) {
            let referrerDomain = new URL(referrer).hostname;

            // Check for email services
            if (emailDomains.some(domain => referrerDomain.includes(domain))) {
                return "email";
            }

            // 3Ô∏è‚É£ Detect Search Engines
            const searchEngines = [
                "google.com", "bing.com", "duckduckgo.com", "yahoo.com",
                "baidu.com", "yandex.ru", "ecosia.org"
            ];
            if (searchEngines.some(engine => referrerDomain.includes(engine))) {
                return "search";
            }

            // 4Ô∏è‚É£ If the referrer is NEW, update storage
            let storedReferrer = localStorage.getItem("original_referrer");
            if (!storedReferrer || storedReferrer !== referrerDomain) {
                localStorage.setItem("original_referrer", referrerDomain);
                return referrerDomain;
            }

            return storedReferrer; // Return previous referrer if unchanged
        }

        // 5Ô∏è‚É£ If no referrer, assume direct visit
        return "direct";
    }

    function updateFormstackIframe() {
        let formstackIframe = document.getElementById("formstack-embed");
        if (!formstackIframe) {
            console.error("üö® Formstack iframe not found!");
            return;
        }

        let referrerSource = getReferrerSource();

        // 6Ô∏è‚É£ FORCE REFRESH referrer storage if new visit
        sessionStorage.setItem("current_referrer", referrerSource);

        let formUrl = "https://charlottehornets.formstack.com/forms/test_utm";
        let queryParams = `?referrer_url=${encodeURIComponent(referrerSource)}`;
        formstackIframe.src = formUrl + queryParams;
        
        console.log("‚úÖ Updated Formstack URL:", formstackIframe.src);
    }

    // Ensure script runs after full page load
    window.onload = function () {
        setTimeout(updateFormstackIframe, 500); // Slight delay to prevent blank page issue
    };
});
</script>


</head>
<body>

    <h1>Embedded Formstack Form with Referrer Tracking</h1>
    
    <!-- Formstack form iframe -->
    <iframe id="formstack-embed" 
            src="https://charlottehornets.formstack.com/forms/test_utm" 
            width="100%" 
            height="800px" 
            frameborder="0">
    </iframe>

</body>
</html>
