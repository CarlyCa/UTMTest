<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Embedded Formstack with Referrer Tracking</title>
  <script>
    document.addEventListener("DOMContentLoaded", function () {

      // Helper: Get a query parameter from the URL
      function getQueryParam(param) {
        let params = new URLSearchParams(window.location.search);
        return params.get(param);
      }

      // Check for known email client identifiers in the user agent string
      function getEmailSourceFromUserAgent() {
        let userAgent = navigator.userAgent.toLowerCase();

        const emailClients = [
          "gmail", "outlook", "yahoo", "icloud", "aol", "zoho", "protonmail",
          "fastmail", "yandex", "gmx", "mail.com"
        ];

        // Loop through the list of email clients and check if any are in the user agent
        for (let client of emailClients) {
          if (userAgent.includes(client)) {
            console.log("‚úÖ Detected Email Click via User-Agent:", client);
            return "email";
          }
        }
        return null; // No email client detected
      }

      // Determine the original referrer source
      function getReferrerSource() {
        let referrer = document.referrer;
        let storedReferrer = localStorage.getItem("original_referrer");

        // 0Ô∏è‚É£ Check for URL parameter (recommended approach)
        if (getQueryParam("utm_source") && getQueryParam("utm_source").toLowerCase() === "email") {
          console.log("‚úÖ Detected Email Click via URL parameter");
          localStorage.setItem("original_referrer", "email");
          return "email";
        }

        // 1Ô∏è‚É£ Fallback: Check the user agent for email client signatures
        let emailSource = getEmailSourceFromUserAgent();
        if (emailSource) {
          localStorage.setItem("original_referrer", "email");
          return "email";
        }

        // 2Ô∏è‚É£ Detect Facebook, Messenger, or Instagram clicks via fbclid
        if (getQueryParam("fbclid")) {
          console.log("‚úÖ Detected Facebook Click");
          localStorage.setItem("original_referrer", "facebook.com");
          return "facebook.com";
        }

        // 3Ô∏è‚É£ Handle Facebook redirects (from l.facebook.com or lm.facebook.com)
        if (referrer.includes("l.facebook.com") || referrer.includes("lm.facebook.com")) {
          console.log("üö® Ignoring Facebook Redirect (l.facebook.com)");
          return storedReferrer || "direct";
        }

        // 4Ô∏è‚É£ Default: Use the stored referrer or set as direct
        return storedReferrer || "direct";
      }

      // Update the Formstack iframe URL with the detected referrer source
      function updateFormstackIframe() {
        let formstackIframe = document.getElementById("formstack-embed");
        if (!formstackIframe) {
          console.error("üö® Formstack iframe not found!");
          return;
        }

        let referrerSource = getReferrerSource();
        let formUrl = "https://charlottehornets.formstack.com/forms/test_utm";
        let queryParams = `?referrer_url=${encodeURIComponent(referrerSource)}`;
        formstackIframe.src = formUrl + queryParams;

        console.log("‚úÖ Updated Formstack URL:", formstackIframe.src);
      }

      // Run the update after the page loads
      window.onload = function () {
        setTimeout(updateFormstackIframe, 500);
      };
    });
  </script>
</head>
<body>
  <h1>Embedded Formstack Form with Referrer Tracking</h1>
  
  <!-- Formstack form iframe -->
  <iframe id="formstack-embed" 
          src="https://charlottehornets.formstack.com/forms/test_utm" 
          width="100%" 
          height="800px" 
          frameborder="0">
  </iframe>
</body>
</html>
