=<!DOCTYPE html>
<html lang="en">
<head>
    <title>Embedded Formstack with Referrer Tracking</title>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            function getQueryParam(param) {
                let urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(param);
            }
        
            function getReferrerSource() {
                let referrer = document.referrer;
                let storedReferrer = localStorage.getItem("original_referrer");
        
                // 1Ô∏è‚É£ Detect Facebook, Messenger, Instagram via fbclid
                if (getQueryParam("fbclid")) {
                    console.log("Detected Facebook Click: fbclid is present");
                    localStorage.setItem("original_referrer", "facebook.com");
                    return "facebook.com";
                }
        
                // 2Ô∏è‚É£ Handle Facebook Redirects (l.facebook.com) - Ignore it and use stored referrer
                if (referrer.includes("l.facebook.com") || referrer.includes("lm.facebook.com")) {
                    console.log("Ignoring Facebook Redirect (l.facebook.com)");
                    return storedReferrer || "direct";
                }
        
                // 3Ô∏è‚É£ Detect If This Link Was Sent via Email (Special URL Parameter)
                if (getQueryParam("source") === "email") {
                    console.log("Detected Email Click via UTM");
                    localStorage.setItem("original_referrer", "email");
                    return "email";
                }
        
                // 4Ô∏è‚É£ Detect Email Clicks Using Known Email Domains
                const emailDomains = [
                    "mail.google.com", "outlook.live.com", "yahoo.com", "icloud.com",
                    "aol.com", "zoho.com", "mail.proton.me", "fastmail.com",
                    "yandex.com", "gmx.com", "mail.com"
                ];
                if (referrer) {
                    let referrerDomain = new URL(referrer).hostname;
        
                    // Check for email services
                    if (emailDomains.some(domain => referrerDomain.includes(domain))) {
                        console.log("Detected Email Click");
                        localStorage.setItem("original_referrer", "email");
                        return "email";
                    }
        
                    // 5Ô∏è‚É£ Detect Search Engines
                    const searchEngines = [
                        "google.com", "bing.com", "duckduckgo.com", "yahoo.com",
                        "baidu.com", "yandex.ru", "ecosia.org"
                    ];
                    if (searchEngines.some(engine => referrerDomain.includes(engine))) {
                        console.log("Detected Search Engine Click");
                        localStorage.setItem("original_referrer", "search");
                        return "search";
                    }
        
                    // 6Ô∏è‚É£ Store Original Referrer If New
                    if (!storedReferrer || storedReferrer !== referrerDomain) {
                        localStorage.setItem("original_referrer", referrerDomain);
                    }
                    return referrerDomain;
                }
        
                // 7Ô∏è‚É£ If no referrer and no UTM, assume direct
                if (!storedReferrer) {
                    localStorage.setItem("original_referrer", "direct");
                }
        
                return localStorage.getItem("original_referrer");
            }
        
            function updateFormstackIframe() {
                let formstackIframe = document.getElementById("formstack-embed");
                if (!formstackIframe) {
                    console.error("üö® Formstack iframe not found!");
                    return;
                }
        
                // 8Ô∏è‚É£ Get updated referrer from localStorage
                let referrerSource = getReferrerSource();
        
                let formUrl = "https://charlottehornets.formstack.com/forms/test_utm";
                let queryParams = `?referrer_url=${encodeURIComponent(referrerSource)}`;
                formstackIframe.src = formUrl + queryParams;
                
                console.log("‚úÖ Updated Formstack URL:", formstackIframe.src);
            }
        
            // 9Ô∏è‚É£ Clear Old Referrer if New Visit Detected
            if (!sessionStorage.getItem("sessionStarted")) {
                console.log("New session detected, clearing old referrer");
                localStorage.removeItem("original_referrer"); 
                sessionStorage.setItem("sessionStarted", "true"); 
            }
        
            // 10Ô∏è‚É£ Run on Page Load
            window.onload = function () {
                setTimeout(updateFormstackIframe, 500);
            };
        });
        </script>
        
</head>
<body>

    <h1>Embedded Formstack Form with Referrer Tracking</h1>
    
    <!-- Formstack form iframe -->
    <iframe id="formstack-embed" 
            src="https://charlottehornets.formstack.com/forms/test_utm" 
            width="100%" 
            height="800px" 
            frameborder="0">
    </iframe>

</body>
</html>
