=<!DOCTYPE html>
<html lang="en">
<head>
    <title>Embedded Formstack with Referrer Tracking</title>

<script>
document.addEventListener("DOMContentLoaded", function () {
    function getEmailSourceFromUserAgent() {
        let userAgent = navigator.userAgent.toLowerCase();

        const emailClients = [
            "gmail", "outlook", "yahoo", "icloud", "aol", "zoho", "protonmail",
            "fastmail", "yandex", "gmx", "mail.com"
        ];

        // Check if any known email client is in the user-agent
        for (let client of emailClients) {
            if (userAgent.includes(client)) {
                console.log("‚úÖ Detected Email Click via User-Agent:", client);
                return "email";
            }
        }

        return null; // No email client detected
    }

    function getReferrerSource() {
        let referrer = document.referrer;
        let storedReferrer = localStorage.getItem("original_referrer");

        // 1Ô∏è‚É£ Try detecting email click via User-Agent
        let emailSource = getEmailSourceFromUserAgent();
        if (emailSource) {
            localStorage.setItem("original_referrer", "email");
            return "email";
        }

        // 2Ô∏è‚É£ Detect Facebook, Messenger, Instagram via fbclid
        if (getQueryParam("fbclid")) {
            console.log("‚úÖ Detected Facebook Click");
            localStorage.setItem("original_referrer", "facebook.com");
            return "facebook.com";
        }

        // 3Ô∏è‚É£ Handle Facebook Redirects (l.facebook.com)
        if (referrer.includes("l.facebook.com") || referrer.includes("lm.facebook.com")) {
            console.log("üö® Ignoring Facebook Redirect (l.facebook.com)");
            return storedReferrer || "direct";
        }

        // 4Ô∏è‚É£ Default to stored referrer or direct
        return storedReferrer || "direct";
    }

    function updateFormstackIframe() {
        let formstackIframe = document.getElementById("formstack-embed");
        if (!formstackIframe) {
            console.error("üö® Formstack iframe not found!");
            return;
        }

        let referrerSource = getReferrerSource();
        let formUrl = "https://charlottehornets.formstack.com/forms/test_utm";
        let queryParams = `?referrer_url=${encodeURIComponent(referrerSource)}`;
        formstackIframe.src = formUrl + queryParams;
        
        console.log("‚úÖ Updated Formstack URL:", formstackIframe.src);
    }

    // Run on Page Load
    window.onload = function () {
        setTimeout(updateFormstackIframe, 500);
    };
});
</script>

</head>
<body>

    <h1>Embedded Formstack Form with Referrer Tracking</h1>
    
    <!-- Formstack form iframe -->
    <iframe id="formstack-embed" 
            src="https://charlottehornets.formstack.com/forms/test_utm" 
            width="100%" 
            height="800px" 
            frameborder="0">
    </iframe>

</body>
</html>
