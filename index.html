<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Embedded Formstack with Actual Referrer Tracking</title>
  <script>
    document.addEventListener("DOMContentLoaded", function () {

      // Helper: Get a query parameter from the URL
      function getQueryParam(param) {
        const params = new URLSearchParams(window.location.search);
        return params.get(param);
      }

      // Helper: Extract the hostname (domain) from a URL string.
      function extractDomain(url) {
        try {
          return new URL(url).hostname;
        } catch (e) {
          return url;
        }
      }

      // Determine the referrer for this session.
      // Priority:
      // 1. utm_source query parameter (e.g. for email)
      // 2. fbclid query parameter (set as "facebook.com")
      // 3. document.referrer (domain only)
      // 4. Defaults to "direct"
      function getReferrerSource() {
        let currentSource = "";

        // 1. If there's a utm_source parameter, use it.
        const utmSource = getQueryParam("utm_source");
        if (utmSource) {
          currentSource = utmSource;
          console.log("âœ… Detected source via utm_source:", currentSource);
        }
        // 2. If there's a fbclid parameter, set as "facebook.com"
        else if (getQueryParam("fbclid")) {
          currentSource = "facebook.com";
          console.log("âœ… Detected Facebook click via fbclid");
        }
        // 3. Otherwise, use document.referrer (extract domain)
        else if (document.referrer) {
          currentSource = extractDomain(document.referrer);
          console.log("âœ… Detected referrer from document.referrer:", currentSource);
        }
        // 4. Default to "direct"
        else {
          currentSource = "direct";
          console.log("âœ… No referrer detected, defaulting to direct");
        }

        // Use sessionStorage (not localStorage) so the value resets each session.
        sessionStorage.setItem("original_referrer", currentSource);
        return currentSource;
      }

      // Update the Formstack iframe URL with the determined referrer source.
      function updateFormstackIframe() {
        const formstackIframe = document.getElementById("formstack-embed");
        if (!formstackIframe) {
          console.error("ðŸš¨ Formstack iframe not found!");
          return;
        }

        const referrerSource = getReferrerSource();
        const formUrl = "https://charlottehornets.formstack.com/forms/test_utm";
        const queryParams = `?referrer_url=${encodeURIComponent(referrerSource)}`;
        formstackIframe.src = formUrl + queryParams;

        console.log("âœ… Updated Formstack URL:", formstackIframe.src);
      }

      // Run the update after the page loads (with a small delay)
      window.onload = function () {
        setTimeout(updateFormstackIframe, 500);
      };

    });
  </script>
</head>
<body>
  <h1>Embedded Formstack Form with Actual Referrer Tracking</h1>
  
  <!-- Formstack form iframe -->
  <iframe id="formstack-embed" 
          src="https://charlottehornets.formstack.com/forms/test_utm" 
          width="100%" 
          height="800px" 
          frameborder="0">
  </iframe>
</body>
</html>
